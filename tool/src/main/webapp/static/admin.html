<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Course Signup</title>

<link rel="stylesheet" type="text/css"
	href="lib/jqmodal-r14/jqModal.css" />
<link rel="stylesheet" type="text/css" href="tool_base.css" />
<link rel="stylesheet" type="text/css" href="tool.css" />
		<link rel="stylesheet" type="text/css" href="lib/dataTables-1.7/css/demo_table_jui.css"/>
		<link rel="stylesheet" type="text/css" href="lib/jquery-ui-1.8.2.custom/css/smoothness/jquery-ui-1.8.2.custom.css"/>

<script type="text/javascript"
	src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js">
		</script>
<script type="text/javascript"
	src="lib/jstree-1.0rc/_lib/jquery.cookie.js">
		</script>
<script type="text/javascript" src="lib/jstree-1.0rc/jquery.jstree.js">
		</script>
<script type="text/javascript" src="lib/jqmodal-r14/jqModal.js">
		</script>
<script type="text/javascript"
	src="lib/trimpath-template-1.0.38/trimpath-template.js">
		</script>
<script type="text/javascript"
	src="lib/dataTables-1.7/js/jquery.dataTables.js">
		</script>
<script type="text/javascript"
	src="lib/dataTables-1.6/js/jquery.dataTables.reloadAjax.js">
		</script>
		<script type="text/javascript" src="lib/serverDate.js">
		</script>
		<script type="text/javascript" src="lib/signup.js">
		</script>
		
<script type="text/javascript">
			$(function(){

				var processSignupRow = function(item) {
					var components = $.map(item.components, function(component) {
						return component.title+ " "+ component.slot+ "<br>("+ component.places+ " places)";
					}).join("<br>");
					return [
							'<a href="mailto:'+item.user.email+ '">'+item.user.name +'</a>',
							item.id,
							(item.supervisor)?item.supervisor.name:"",
							components,
							item.status,
							Signup.signup.formatActions(Signup.signup.getActions(item.status, item.id))
					];
				};
				
				/**
				 * Gets the status of a component. This is used on the admin page to show what state the component is in.
				 * @param {Object} component
				 * @return A string to represent the status of this component.
				 */
				var getComponentStatus = function(opens, closes) {
					var now = $.serverDate();
					if (now < opens) {
						return "Pending";
					} else if (now < closes) {
						return "Open";
					} else {
						return "Closed";
					}
				};
				// 
				$("#course-list").html('<table cellpadding="0" cellspacing="0" border="0" class="display" id="course-list-table"></table>');
				var courseList = $("#course-list-table").dataTable( {
					"aoColumns": [
						{
							"sTitle": "Course"
						},
						{
							"sTitle": "Code",
							"bVisible": false
						}
					],
					"sAjaxSource": "/course-signup/rest/course/admin",
					"fnServerData": function(sSource, aoData, fnCallback) {
						$.getJSON(sSource, [], function(data) {
							var tableData = {
										"aaData": []
							};
							$.each(data, function(index, value) {
								tableData.aaData.push([value.title, value.id]);
							});
							fnCallback(tableData);
						});
					},
					"fnRowCallback": function(nRow, aData, iIndex) {
						$(nRow).bind("click", {"code": aData[1], "name": aData[0]}, function(e) {
							var code = e.data.code;
							var name = e.data.name;

							// Table showing the components.
							$("#summary").html('<h3>'+ name +'</h3><table border="0" class="display" id="summary-table"></table>');
							var summary = $("#summary-table").dataTable( {
								"bProcessing": true,
								"bPaginate": false,
								"bLengthChange": false,
								"bFilter": false,
								"bSort": false,
								"bInfo": false,
								"bAutoWidth": false,
								"sAjaxSource": "/course-signup/rest/course/",
								"aoColumns": [
								              {"sTitle": "Component"},
											  {"sTitle": "Size"},
								              {"sTitle": "Places"},
											  {
											  	"sTitle": "Signup Period",
												"fnRender": function(aObj) {
													// Hack to force the data back to being a int.
													return new Date(+aObj.aData[3]).toDateString() + " (for "+ Signup.util.formatDuration(aObj.aData[8] - aObj.aData[3])+ ")";
												},
												"bUseRendered": false
											  },
											  {"sTitle": "Term"},
								              {
											  	"sTitle": "Status",
												"fnRender": function(aObj) {
													return getComponentStatus(aObj.aData[3], aObj.aData[8]);
												}
											  },
											  {"bVisible": false},
											  {"bVisible": false},
											  {"bVisible": false}
								              ],
					
								"fnServerData": function(sSource, aoData, fnCallback) {
									$.getJSON(sSource+code, {"range": "ALL"}, function(data) {
										var tableData = {
												"aaData": []
										};
										for(var i in data.components) {
											var component = data.components[i];
											tableData.aaData.push([
											 component.title,
											 component.size,
											 component.places,
											 component.opens,
											 component.when, //4
											 component.sessions,
											 component.presenter,
											 component.administrator,
											 component.closes, //8
											]);
										}
										fnCallback(tableData);
									});
								}
							});
							
							$("#signups").html('<table border="0" class="display" id="signups-table"></table><a href="#" id="signup-add">Add</a>');
							
							var signupAddUser = $("#signup-add-user-win");
							signupAddUser.resize(function(e){
								// Calculate size.
								console.log("reseize");
							});
							signupAddUser.jqm({
								onShow: function(objs) {
									$("body").css("overflow", "hidden");
									objs.w.css('opacity',1).show();
								},
								onHide: function(objs) {
									$("body").css("overflow", "auto");
									objs.w.fadeOut('250',function(){ objs.o.remove(); });
								}
							});
							$("#signup-add").click(function(){
								signupAddUser.jqmShow();
								console.log(signupAddUser.height());
								console.log(signupAddUser.innerHeight());
								// Need to resize to content.
								var windowHeight = $(window).height();
								var positionTop = signupAddUser[0].offsetTop;
								if (windowHeight < signupAddUser.outerHeight() + positionTop) {
									// Too big.
									var newHeight = windowHeight - (signupAddUser.outerHeight(false) - signupAddUser.height()) -2;
									signupAddUser.height(newHeight);
									signupAddUser.css("top", "1px"); // Move almost to the top.
									
									console.log("resize "+ windowHeight+ " "+newHeight );
								};
								
							});
							$(window).resize(function(){
								var windowHeight = $(window).height();
								var positionTop = signupAddUser[0].offsetTop;
								if (windowHeight < signupAddUser.outerHeight() + positionTop) {
									// Too big.
									var newHeight = windowHeight - (signupAddUser.outerHeight(false) - signupAddUser.height()) -2;
									signupAddUser.height(newHeight);
									signupAddUser.css("top", "1px"); // Move almost to the top.
									
									console.log("resize "+ windowHeight+ " "+newHeight );
								};
							});
							
							signupAddUser.bind("submit", function(e) {
								var users = e.target.users.value;
								// Need error handling when empty.
								var goodUsers = [];
								var badUsers = [];
								$.each(users.split(/\s+/), function() {
									var that = this;
									if (!this || this.length < 1) {
										return;
									}
									$.ajax({
										"url": "/course-signup/rest/user/find",
										"method": "GET",
										"async": false, // So we don't overload the server.
										"data": {"search": this.toString()},
										"success": function(data) {
											goodUsers.push(data);
										},
										"error": function() {
											badUsers.push(that.toString());
										}
									})
								});
								if (badUsers.length > 0) {
									// Display list of bad user.
									$(".errors",this).html("Couldn't find user"+ (badUsers.length > 1?"s":"")+ ": "+ badUsers.join(", "));
								} else {
									// Show next page...
									$.getJSON("/course-signup/rest/course/"+code, {"range": "ALL"}, function(data){
										var components = data.components;
										var output = TrimPath.processDOMTemplate("signup-add-components-tpl", data);
										signupAddUser.jqmHide();
										var window = $("#signup-add-components-win");
										window.html(output);
										window.jqm();
										window.jqmShow();
										// Bind on the form submit.
										$("#signup-add-components").bind("submit", function(e){
											//
											var components = [];
											$("[type=checkbox]", this).each(function() {
												if(this.checked) {
													components.push(this.id.substring(7)); // Remove 'option-' prefix
												}
											});
											if (components.length == 0) {
												//error.
											}
											// Go sign them up.
											$.each(goodUsers, function() {
												var user = this;
												$.ajax({
													"url": "/course-signup/rest/signup/new",
													"type": "POST",
													"async": false,
													"traditional": true,
													"data": {"userId": user.id, "courseId": code, "components": components},
													"success": function(data) {
														console.log("Good for "+ user.id);
													}
												});
											});
											return false;
										});
									});
								}
								
								return false;
							});
							
							var signups = $("#signups-table").dataTable( {
								"bProcessing": true,
								"bPaginate": false,
								"bLengthChange": false,
								"bFilter": false,
								"bSort": false,
								"bInfo": false,
								"bAutoWidth": false,
								"sAjaxSource": "/course-signup/rest/signup/course/",
								"aoColumns": [ // Need to have this here at init.
								              {"sTitle": "Student"},
								              {"sTitle": "Signup Code", "bVisible": false},
								              {"sTitle": "Supervisor"},
								              {"sTitle": "Components"},
								              {"sTitle": "Status"},
								              {"sTitle": "Actions"}
								],
								"fnServerData": function(sSource, aoData, fnCallback) {
									// Load the data an process it.
									$.getJSON(sSource+code, [], function(data) {
										var tableData = { // Data for datatables.
											"aaData": []
										};
										for(i in data) {
											var item = processSignupRow(data[i]);
											tableData.aaData.push(item);
										}
										console.log(tableData);
										fnCallback(tableData);
									});
								},
								"fnRowCallback": function(nRow, aData, iDisplayIndex) {
									$("a.action", nRow).bind("click", function(e) {
										var url = $(this).attr("href");
										var signupId = aData[1];
										$.ajax({
											"url": url,
											"type": "POST",
											"success": function(data) {
												signups.fnReloadAjax();
											}
										});
										return false;
									});
									return nRow;
								}
							}); 
						});
						return nRow;
					},
					"bPaginate": false,
					"bLengthChange": false,
					"bFilter": false,
					"bSort": false,
					"bInfo": false,
					"bAutoWidth": false
				});
			});
			
		</script>

<style type="text/css">
.location {
	font-size: smaller;
}

.error {
	color: red;
}

table th {
	text-align: left;
}

#summary {
	background: #bbb;
}

#parts table th {
	padding: 0.5em;
}

#parts table td {
	vertical-align: top;
	/* Indent all but first line */
	padding-left: 3em;
	text-indent: -3em;
}

#browse {
	width: 30%;
	float: left;
	overflow: hidden;
}

#details {
	width: 69%;
	float: right;
}

.loader {
	float: left;
}

.jqmWindow {
	z-index: 1000; /* To keep below autocomplete */
	background: white;
	overflow: auto;
}
</style>
</head>
<body>
<div id="toolbar">
<ul class="navIntraTool actionToolBar">
	<li><span><a href="index.html">Course Signup</a></span></li>
	<li><span><a href="my.html">My Courses</a></span></li>
	<li><span><a href="pending.html">Pending Acceptances</a></span></li>
	<li><span>Course Administration</span></li>
	<li><span><a href="debug.html">Debug</a></span></li>
</ul>
</div>

<div id="course-list"><!-- Browse the areas which there are courses -->
</div>
<div id="details"><!-- Show details of the course -->
<div id="summary"></div>
<div id="signups"></div>
</div>



<!-- Hidden extra bits -->
<!-- Popup window for finding users.-->
<div id="signup-add-user-win" class="jqmWindow" style="display: none">
	<h2>Find users</h2>
	<form id="signup-add-user">
		<div class="errors"></div>
		<textarea name="users" id="add-users" cols="30" rows="8"></textarea><br>
		<input type="submit" value="Find">
	</form>
</div>

<!-- Popup window for selecting components. -->
<div id="signup-add-components-win" class="jqmWindow" style="display:none">

</div>

<textarea id="signup-add-components-tpl" style="display:none" rows="0" cols="0">
	<h2>Select components</h2>
	<form id="signup-add-components">
	<ul>
	{for component in components}
		<li>
			<input type="checkbox" name="${component.id}" id="option-${component.id}" value="true">
			<label for="component-${component.id}">${component.title} - ${component.slot} for ${component.sessions} sessions in ${component.when},
					{if component.presenter}<a href="mailto:${component.presenter.email}">${component.presenter.name}</a>{/if}
					</label>
                                <br />
                                <span class="location">${component.location}</span>
		</li>
	{/for}
	</ul>
		<input type="submit" value="Add">
	</form>
</textarea>

<textarea id="parts-confirm-tpl" style="display: none;" rows="0"
	cols="0">
			{var textarea = "textarea"}
			<div>
				<ul>
				{for component in components}
					<li>${component}</li>
				{/for}
				</ul>
			</div>
			<div>
			<form id="signup-confirm" action="#">
				{for componentId in componentIds}
				<input type="hidden" name="components" value="${componentId}" />
				{/for}
				<table>
					<tr>
						<th>
							<label for="supervisor-email">Supervisor Email</label>
						</th>
						<td><input type="text" class="valid-email" name="email"
			id="supervisor-email" size="40" /></td>
					</tr>
					<tr>
						<th>
							<label for="supervisor-note">Message to supervisor</label>
						</th>
						<td><${textarea} name="message" id="supervisor-note" cols="40" rows="8"></${textarea}></td>
					</tr>
				</table>
				<input type="submit" value="Confirm Signup" />
				<input type="submit" class="cancel" value="Cancel" />
			</form>
			</div>
		</textarea>

<!-- ** Template for displaying a course ** -->
<textarea id="details-tpl" style="display: none" rows="0" cols="0">
            <!-- Show details of the course -->
            <div id="summary" class="">
                <h3>${title}</h3>
                <table width="100%">
                	<tr>
                        <th>
                            Lecturers
                        </th>
                        <td>
                            {for presenter in presenters}
								<a href="mailto:${presenter.email}">${presenter.name}</a>
							{/for}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Course Administrators
                        </th>
                        <td>
                            {for admin in administrators}
								<a href="mailto:${admin.email}">${admin.name}</a>
							{/for}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Department
                        </th>
                        <td>
                            ${departmentCode}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Signup Available
                        </th>
                        <td>
                            13th September 2010 to 29th September 2010 (opens in 34 days)
                        </td>
                    </tr>
                </table>
            </div>
            <div id="description">
            	<h4>Description</h4>
				${description}
            </div>
			<div id="parts">
                <h4>Course Parts</h4>
				<span class="error" style="display: none"></span>
                <form id="signup" action="#">
                    <table width="100%">
                    	{for part in parts}
						<tr>
                            <th colspan="3">
                                ${part.type.name}
                            </th>
                        </tr>
						{var oneOpen = false}
						{for option in part.options}
                        <tr>
                            <td class="option-details">
                                <label for="option-${option.id}">${option.slot} for ${option.sessions} sessions in ${option.when},
								{if option.presenter}<a href="mailto:${option.presenter.email}">${option.presenter.name}</a>{/if}
								</label>
                                <br />
                                <span class="location">${option.location}</span>
                            </td>
                            <td>
                            	{if option.full}
									full
								{else}
									${option.places} places
								{/if}
                            </td>
                            <td>
                                <input type="radio"
			name="${part.type.id}" id="option-${option.id}" value="${option.id}"
			{if option.full || !option.open }disabled="true" {else}{var
			oneOpen=true}{/if} />
                            </td>
                        </tr>
						{/for}
						{if parts.length > 1 && oneOpen}
						<tr>
							<td class="option-details">
								<label for="option-none-${part.type.id}">Nothing for this option</label>
							</td>
							<td>N/A</td>
							<td><input type="radio" name="${part.type.id}"
			id="option-none-${part.type.id}" value="none" /></td>
						</tr>
						{/if}
						{/for}
                    </table><input type="submit" value="Signup" {if
	full || !open}disabled="true" {/if}/>
                </form>
            </div>
		</textarea>

</body>
</html>