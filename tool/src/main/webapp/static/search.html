<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
	@IMPORT url("css/jquery.autocomplete.css");
	.my_ac_loading {
		background : Window url('images/ajax-loader.gif') right center no-repeat;
	};
</style>
<title>Insert title here</title>
<script type="text/javascript" src="js/jquery-1.3.js"></script>
<script type="text/javascript" src="js/jquery.autocomplete.js"></script>
<script type="text/javascript" src="js/trimpath-template-1.0.38.js"></script>
<script type="text/javascript">
	jQuery(document).ready(function(){

		this.url = function(param) {
			var regex = '[?&]' + param + '=([^&#]*)';
			var results = (new RegExp(regex)).exec(window.location.href);
			if(results) return results[1];
				return '';
		}


		var site = this.url("site");
		
		jQuery.ajax({
			url: "../site/"+ site+ "/addgroup",
            method: "GET",
			success: function(json, textStatus) {
				eval("var siteData = "+ json);
				var content = TrimPath.processDOMTemplate("find_jst", siteData);
				jQuery("#content").html(content);
				// Add autocomplete support.
				jQuery("#ldap-search").autocomplete("../group/autocomplete", {
					loadingClass: "my_ac_loading"
				});

				// Add the display members support.
				jQuery("form.find-group").bind("submit", function(event) {
					var groupName = jQuery("#ldap-search").val();
					if (groupName) {
						var submit = jQuery("form.find-group input[type='submit']");
						submit.attr("disabled","true");
						jQuery.getJSON("../group/search", {"q": groupName}, function(data, textStatus) {
							submit.removeAttr("disabled");
							if (textStatus == "success") {
								if (data.length == 1) {
									// Wooho
									var group = data[0];
									var htmlResult = TrimPath.processDOMTemplate("group_jst", {group: group, site: siteData});
									jQuery("#content").append(htmlResult);
									jQuery.getJSON("../group/"+ group.id+ "/members", {}, function(data, textStatus) {
										// loading members.
										if (textStatus == "success") {
											var htmlResult = TrimPath.processDOMTemplate("membership_jst", {"members": data});
											jQuery(".show-group .members").html(htmlResult);

										}
									});
									jQuery("form.show-group").
										bind("submit", function(event) {
											var role = jQuery("form.show-group input[name=role]:checked").val();
											if (role != null) {
												console.log("Selected role: "+role+ " group is "+ group.id);
												jQuery.ajax({
													url: "../mapped/",
													type: "POST",
													data: {group: group.id, role: role},
													success: function(json, textStatus) {
														eval("var data = "+ json);
														console.log(data);
													},
													error: function() {
														console.log("tits up");
													}
												});

											}
											return false;
										});
								} else if (data.length == 0) {

								} else {

								}
							}
						});
					}
					return false;
				});
			},
		error: function(xhr, textStatus, errorThrown) {
			alert("bugger me");
		}
		});
	});

</script>
</head>
<body>
<div style="display:none">
	<textarea id="find_jst">
		<div class="find">
		<h1>Adding group for ${title}</h1>
		<form class="find-group">
		<fieldset>
		<label>Find a group:</label>
		<input type="text" id="ldap-search" name="group" size="30"/>
		<span id="ldap-search-error" class="error"></span>
		</fieldset>
		<input type="submit" value="Next"/>
		</form>
		</div>
	</textarea>
	<textarea id="group_jst">
		<form class="show-group">
		<h4 class="group">${group.name}</h4>
		<h5>Membership</h5>
		{for role in site.roles}
		<label for="${role.id}">${role.id}</label>
		<input id="access" type="radio" name="role" value="${role.id}"><br/>
		{/for}
		<input type="submit" value="Add Group"/>

		<ul class="members">
			<li>Loading<img src="images/ajax-loader.gif"/></li>
		</ul>
		

		</form>
	</textarea>
	<textarea id="membership_jst">
		{for member in members}
		<li>${member.name} <span class="username">(${member.username})</span></li>
		{/for}
	</textarea>
</div>



<div id="content">
	<!-- Templates get put in here .... -->
</div>
	

</body>
</html>