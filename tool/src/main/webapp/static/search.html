<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="/local-skins/tool_base.css" type="text/css" rel="stylesheet" media="all" />
<!--  TODO: Need to pull current skin from somewhere. -->
<link href="/local-skins/weblearn-beta/tool.css" type="text/css" rel="stylesheet" media="all" />

<style type="text/css">
	@IMPORT url("css/jquery.autocomplete.css");
	.my_ac_loading {
		background : url('images/ajax-loader.gif') right center no-repeat;
	};
    .loader {
        padding-left: 1em;
        padding-right: 1em;
    }
</style>
<title>External Groups</title>
<script type="text/javascript" src="js/jquery-1.3.js"></script>
<script type="text/javascript" src="js/jquery.autocomplete.js"></script>
<script type="text/javascript" src="js/trimpath-template-1.0.38.js"></script>
<script type="text/javascript" src="/library/js/headscripts.js"></script>
<script type="text/javascript">
	jQuery(function(){
		
		path = "/external-groups/rest/";
		this.url = function(param) {
			var regex = '[?&]' + param + '=([^&#]*)';
			var results = (new RegExp(regex)).exec(window.location.href);
			if(results) return results[1];
				return '';
			
		}
		// Support running as a helper.
		var placement = this.url("sakai.tool.placement.id");
		var frameId = "Main"+placement;
		frameId = frameId.replace(/-/g, "x");
		
		// Don't shrink frame as autocomplete needs space.
		// setMainFrameHeightNow(frameId);
		//"Main55ac72dd149b-4fbd-bc3e-34339a656940"
		//"Main55ac72ddx149bx4fbdxbc3ex34339a656940"
		
		jQuery.ajax({
			url: path+ "site/placement/"+placement,
            method: "GET",
			success: function(json, textStatus) {
				eval("var siteData = "+ json);
				var site = siteData.id;
				var content = TrimPath.processDOMTemplate("find_jst", siteData);
				jQuery("#search").html(content);
				// Add autocomplete support.
				jQuery("#ldap-search").autocomplete(path+ "group/autocomplete", {
					loadingClass: "my_ac_loading"
				});

				// Add the display members support.
				jQuery("form.find-group").bind("submit", function(event) {
					var groupName = jQuery("#ldap-search").val();
					if (groupName) {
						var submit = jQuery("form.find-group input[type='submit']");
						submit.attr("disabled","true");
						jQuery.getJSON(path+ "group/search", {"q": groupName}, function(data, textStatus) {
							submit.removeAttr("disabled");
							if (textStatus == "success") {
								if (data.length == 1) {
									// Wooho
									var group = data[0];
									var htmlResult = TrimPath.processDOMTemplate("group_jst", {group: group, site: siteData});
									jQuery("#group").html(htmlResult);
									setMainFrameHeightNow(frameId);
									jQuery.getJSON(path+ "group/"+ group.id+ "/members", {}, function(data, textStatus) {
										// loading members.
										if (textStatus == "success") {
											var htmlResult = TrimPath.processDOMTemplate("membership_jst", {"members": data});
											jQuery(".show-group .members").html(htmlResult);
											setMainFrameHeightNow(frameId);

										}
									});
									jQuery("form.show-group").
										bind("submit", function(event) {
											var role = jQuery("form.show-group input[name=role]:checked").val();
											if (role != null) {
												console.log("Selected role: "+role+ " group is "+ group.id);
												jQuery.ajax({
													url: path+ "mapped/",
													type: "POST",
													data: {group: group.id, role: role, site: site},
													success: function(json, textStatus) {
														console.log(data);
														window.location = "./../done.jsp";
													},
													error: function() {
														console.log("tits up");
													}
												});

											}
											return false;
										});
								} else if (data.length == 0) {

								} else {

								}
							}
						});
					}
					return false;
				});
			},
		error: function(xhr, textStatus, errorThrown) {
			alert("bugger me");
		}
		});
	});

</script>
</head>
<body>
<div style="display:none">
	<textarea id="find_jst">
		<div class="find">
		<h3>Adding group to ${title}...</h3>
		<form class="find-group">
		<fieldset>
		<label>Find a group:</label>
		<input type="text" id="ldap-search" name="group" size="30"/>
		<span id="ldap-search-error" class="error"></span>
		</fieldset>
		<input type="submit" value="Next"/>
		</form>
		</div>
	</textarea>
	<textarea id="group_jst">
		<form class="show-group">
		<h4 class="group">${group.name}</h4>
		<h5>Membership</h5>
		<table>
		{for role in site.roles}
		<tr>
		<td><label for="${role.id}">${role.id}</label></td>
		<td><input id="${role.id}" type="radio" name="role" value="${role.id}"></td>
		</tr>
		{/for}
		</table>
		<input type="submit" value="Add Group"/>

		<ul class="members">
			<li>Loading<img class="loader" src="images/ajax-loader.gif"/></li>
		</ul>
		

		</form>
	</textarea>
	<textarea id="membership_jst">
		{for member in members}
		<li>${member.name} <span class="username">(${member.username})</span></li>
		{/for}
	</textarea>
</div>



<div id="content">
	<div id="search"></div>
	<div id="group"></div>
</div>
	

</body>
</html>