<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="/local-skins/tool_base.css" type="text/css" rel="stylesheet" media="all" />
<!--  TODO: Need to pull current skin from somewhere. -->
<link href="/local-skins/weblearn-beta/tool.css" type="text/css" rel="stylesheet" media="all" />

<style type="text/css">
	@IMPORT url("css/jquery.autocomplete.css");
	.my_ac_loading {
		background : url('images/ajax-loader.gif') right center no-repeat;
	};
    .loader {
        padding-left: 1em;
        padding-right: 1em;
    }
</style>
<title>External Groups</title>
<script type="text/javascript" src="js/jquery-1.3.js"></script>
<script type="text/javascript" src="js/jquery.autocomplete.js"></script>
<script type="text/javascript" src="js/trimpath-template-1.0.38.js"></script>
<script type="text/javascript" src="/library/js/headscripts.js"></script>
<script type="text/javascript">
	jQuery(function(){

		var updateActive = function() {
			jQuery("input[type=submit]").removeClass("active").filter(":last").addClass("active");
		};
		var loadGroupAjax;
		var loadGroup = function (groupId, groupName) {
			var group = {"id": groupId, "name": groupName};
			var htmlResult = TrimPath.processDOMTemplate("group_jst", {"group": group, "site": siteData});
			jQuery("#group").html(htmlResult);
			setMainFrameHeightNow(frameId);
			loadGroupAjax = jQuery.getJSON(path+ "group/"+ group.id+ "/members", {}, function(data, textStatus) {
				// loading members.
				if (textStatus == "success") {
					var htmlResult = TrimPath.processDOMTemplate("membership_jst", {"members": data});
					jQuery(".show-group .members").html(htmlResult);
					setMainFrameHeightNow(frameId);
					updateActive();
				}
			});
			jQuery("form.show-group").
				bind("submit", function(event) {
					// Remove any error
					jQuery("form.show-group div.alertMessage").remove();
					var role = jQuery("form.show-group input[name=role]:checked").val();
					if (role != null) {
						if (loadGroupAjax.readyState != 4) {
							loadGroupAjax.abort();
						}
						jQuery.ajax({
							url: path+ "mapped/",
							type: "POST",
							data: {group: group.id, role: role, site: siteData.id},
							success: function(json, textStatus) {
								window.location = "./../done.jsp";
							},
							error: function() {
								// TODO Handle failed requests.
							}
						});

					} else {
						jQuery("form.show-group table").after('<div class="alertMessage">You need to select a role</div>');
					}
					return false;
				});
			updateActive();
		};
		
		path = "/external-groups/rest/";
		url = function(param) {
			var regex = '[?&]' + param + '=([^&#]*)';
			var results = (new RegExp(regex)).exec(window.location.href);
			if(results) return results[1];
				return '';
			
		}
		// Support running as a helper.
		var placement = url("sakai.tool.placement.id");
		frameId = "Main"+placement;
		frameId = frameId.replace(/-/g, "x");
		
		// Don't shrink frame as autocomplete needs space.
		// setMainFrameHeightNow(frameId);
		//"Main55ac72dd149b-4fbd-bc3e-34339a656940"
		//"Main55ac72ddx149bx4fbdxbc3ex34339a656940"
		
		jQuery.ajax({
			url: path+ "site/placement/"+placement,
            method: "GET",
			success: function(json, textStatus) {
				eval("siteData = "+json);
				var site = siteData.id;
				var content = TrimPath.processDOMTemplate("find_jst", siteData);
				jQuery("#search").html(content);
				// Add autocomplete support.
				jQuery("#ldap-search").autocomplete(path+ "group/autocomplete", {
					loadingClass: "my_ac_loading"
				});

				// Add the display members support.
				jQuery("form.find-group").bind("submit", function(event) {
					// Clear out previous select group.
					jQuery("#select_group").html("");
					jQuery("#group").html("");
					var groupName = jQuery("#ldap-search").val();
					if (groupName) {
						var submit = jQuery("form.find-group input[type='submit']");
						submit.attr("disabled","true");
						jQuery.getJSON(path+ "group/search", {"q": groupName}, function(data, textStatus) {
							submit.removeAttr("disabled");
							if (textStatus == "success") {
								if (data.length == 1) {
									// Wooho
									var group = data[0];
									loadGroup(group["id"], group["name"]);
									
								} else if (data.length == 0) {
									jQuery("#select_group").html("<div class=\"alertMessage\">No groups matched your query. Try something shorter</div>");
								} else {
									// Should check list to see if we have an exact match first.
									// User needs to select from list.
									var htmlResult = TrimPath.processDOMTemplate("select_group_jst", {groups: data});
									jQuery("#select_group").html(htmlResult);
									updateActive();
									// Need to add onsubmit handling
									jQuery("#select_group").bind("submit", function (event) {
										var input = jQuery("#select_group input[name=group]:checked");
										if (input) {
											var groupId = input.val();
											var groupName = input.parent().parent().children("td:last-child").text();
											loadGroup(groupId, groupName);
										}
										
										return false;
									});
								}
							}
						});
					}
					return false;
				});
			},
		error: function(xhr, textStatus, errorThrown) {
			// TODO Show nice error.
		}
		});
	});

</script>
</head>
<body>
<div style="display:none">
	<textarea id="find_jst">
		<div class="find">
		<h3>Adding group to ${title}...</h3>
		<p class="step">
		Enter the name of a group you wish to find (eg: typing in "college" will find all the colleges).
		</p>
		<form class="find-group">
		<fieldset>
			<label>Search for a group:</label>
			<input type="text" id="ldap-search" name="group" size="30"/>
			<span id="ldap-search-error" class="error"></span>
		</fieldset>
		<div class="act">
			<input class="active" type="submit" value="Next"/>
		</div>
		</form>
		<form id="select_group">
		</form>
		</div>
	</textarea>
	<textarea id="group_jst">
		<form class="show-group">
		<h4 class="group">${group.name}</h4>
		<h5>Roles</h5>
		<p class="step">
		Select the role which you wish the group to have.
		</p>
		<table>
		{for role in site.roles}
		<tr>
		<td><label for="${role.id}">${role.id}</label></td>
		<td><input id="${role.id}" type="radio" name="role" value="${role.id}"></td>
		</tr>
		{/for}
		</table>
		<div class="act">
			<input class="active" type="submit" value="Add Group"/>
		</div>
		<h5>Membership</h5>
		<ul class="members">
			<li>Loading<img class="loader" src="images/ajax-loader.gif"/></li>
		</ul>
		

		</form>
	</textarea>
	<textarea id="membership_jst">
		{for member in members}
		<li>${member.name} <span class="username">(${member.username})</span></li>
		{/for}
	</textarea>

	<!-- When more than one group matches select one from list -->
	<textarea id="select_group_jst">
		<p class="step">
			More than one group matches your search, please select one.
		</p>
		<fieldset id="found_groups">
		<table>
		{for group in groups}
			<tr>
				<td><input type="radio" name="group" value="${group.id}"/></td>
				<td class="name">${group.name}</td>
			</tr>
		{/for}
		</table>
		</fieldset>
		<div class="act">
			<input class="active" type="submit" value="Select"/>
		</div>
	</textarea>
</div>



<div id="content">
	<div id="search"></div>
	<div id="group"></div>
</div>
	

</body>
</html>