<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Course Signup</title>
		
		<link rel="stylesheet" type="text/css" href="lib/jqmodal-r14/jqModal.css"/>
		<link rel="stylesheet" type="text/css" href="tool_base.css"/>
		<link rel="stylesheet" type="text/css" href="tool.css"/>
		
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js">
		</script>
		<script type="text/javascript" src="lib/jstree-1.0rc/_lib/jquery.cookie.js">
		</script>
		<script type="text/javascript" src="lib/jstree-1.0rc/jquery.jstree.js">
		</script>
		<script type="text/javascript" src="lib/jqmodal-r14/jqModal.js">
		</script>
		<script type="text/javascript" src="lib/trimpath-template-1.0.38/trimpath-template.js">
		</script>
		
		<script type="text/javascript">
			jQuery(function() {
				jQuery.getJSON("data/department-tree.json", function(treedata) {
					jQuery("#tree").bind("select_node.jstree", function(event, data) {
			 		    //console.log(data.inst.get_selected()[0].id);
						var id = data.inst.get_selected()[0].id;
						jQuery.getJSON("/course-signup/rest/course/"+ id, {range: "UPCOMING"}, function(data){
							// Preprocess the data.
							data.full = data.places < 1;
							data.teachers = [];
							data.administrators = [];
							var parts = [];
							for(var componentIdx in data.components) {
								var component = data.components[componentIdx];
								if (component.presenter) {
									data.teachers.push(component.presenter);
								}
								if(component.administrator) {
									data.administrators.push(component.administrator);
								}
								if (component.componentSet) {
									var found = false;
									for (var part in parts) {
										if (parts[part].type.id == component.componentSet) {
											parts[part].options.push(component);
											found = true;
										}
									}
									if (!found) {
										parts.push({
											options: [ component ],
											type: {
												id: component.componentSet,
												name: component.title
											}
										});
									}
								}
							}
							data.parts = parts;
							
							var output = TrimPath.processDOMTemplate("details-tpl", data);
							//console.log(output.toString());
                            jQuery("#details").html(output);
                            jQuery("#signup").submit(function(){
                                var radioSelected = {};
                                var errorFound = false;
								var selectedParts = [];
                                jQuery("#signup input:radio").each(function(){
                                    var name = this.name;
                                    if (!radioSelected[name]) {
                                        radioSelected[name] = this.checked;
										// Save the selected parts so we can populate the popup.
										if (this.checked) {
											selectedParts[selectedParts.length]=jQuery(this).parents("tr:first").find(".option-details").html();
										}
                                    }
                                    console.log(name + " " + radioSelected[name]);
                                });
                                for (radio in radioSelected) {
                                    if (!radioSelected[radio]) {
                                        errorFound = true;
                                        jQuery("#parts .error").show().html("Error");
                                    }
                                }
                                if (!errorFound) {
                                    jQuery("#parts .error").hide();
									var listNode = jQuery("#parts-confirm-details").empty()
										.append( jQuery("#summary h3").clone() )
										.append("<ul><li>"+ selectedParts.join("</li><li>") + "</li></ul>");
									
									// Actually show the dialogue (resized first)
                                    var dialog = jQuery("#parts-confirm");
									dialog.height(dialog.innerHeight());
									dialog.jqmShow();
                                }
                                return false;
                            });
						});
					 })
					.bind("open_node.jstree", function (event, data) {
						console.log(data);
						console.log(event);
					})
				 	.jstree({
						json_data: {
							data: treedata,
							ajax: {
								url: function (n) {
									var id = n.attr("id");
									id = id.replace(/-PREVIOUS$/, "");
									return "/course-signup/rest/course/dept/"+ id;
								},
								data: function(n) {
									if (n.attr("id").match(/-PREVIOUS$/)) {
										return {components: "PREVIOUS"};
									}
									return {components: "UPCOMING"};
								},
								dataType: "json",
								success: function (data) {
									if ("UPCOMING" == data.range) {
										data.tree.push({
											"attr":{"id": data.dept+"-PREVIOUS"},
											"data":"Old",
											"state": "closed"
										})
									}
									return data.tree;
								}
							}
							//correct_state: true
						},
						core: {
							initially_open: ["root", "3C", "3C05"] // Open up MPLS for testing.
						},
						plugins: ["themes", "json_data", "ui"]
					});	
				});
			});
			jQuery(
				function() {
					jQuery("#parts-confirm").jqm({modal:false});
			
				}
			);
			
			jQuery(function() {
				var signupConfirm = jQuery("#signup-confirm");
				
				signupConfirm.find(".cancel").click(function(event){
					jQuery("#parts-confirm").jqmHide();
					event.stopPropagation();
					return false;
				});
				signupConfirm.submit(function(event) {
					// Need todo validation 
					var form = jQuery(this);
					var error = false;
					form.find(".error").remove();
					form.find(".msg").remove()
					form.find(".valid-email").each(function() {
						console.log(this);
						var current = jQuery(this);
						if (current.val().length == 0) {
							current.after('<span class="error">* required</span>');
							error = true;
						} else {
							if(!/^([a-zA-Z0-9_.-])+@([a-zA-Z0-9_.-])+\.([a-zA-Z])+([a-zA-Z])+/.test(current.val())){
								current.after('<span class="error">not a valid email</span>');
								error = true;
							}
						}
					});
					
					if (error) {
						return false;
					}
					
					form.find("input:submit:first").attr("disabled", "true").before('<img class="loader" src="images/loader.gif"/>');
					setTimeout(function() {
						form.find("input:submit").removeAttr("disabled");
						form.find(".loader").remove();
					}, 1000);
					return false;
				});
			});
		</script>
		
        <style type="text/css">
            .location {
                font-size: smaller;
            }
			.error {
				color: red;
			}
            
            table th {
                text-align: left;
            }
            
            #summary {
                background: #bbb;
            }
			
			#parts table th {
				padding: 0.5em;
			}
			
			#parts table td {
				vertical-align: top;
				/* Indent all but first line */
				padding-left: 3em;
				text-indent: -3em;
			}
			
			#browse {
				width: 30%;
				float: left;
				overflow: hidden;
			}
			#details {
				width: 69%;
				float: right;
			}
			.loader {
				float: left;
			}
			
			.jqmWindow {
				z-index: 1000; /* To keep below autocomplete */
				background: white;
				overflow: auto;
				height: 300px;
			}
        </style>
    </head>
    <body>
    	<div id="toolbar" >
        	<ul class="navIntraTool actionToolBar">
            <li><span>Course Signup</span></li>
            <li><span><a href="#">My Courses</a></span></li>
            <li><span><a href="#">Pending Acceptances</a></span></li>
            <li><span><a href="#">Course Administration</a></span></li>
			</ul>
        </div>
		
        <div id="browse">
            <!-- Browse the areas which there are courses -->
			<div id="tree"></div>
        </div>
        <div id="details">
            <!-- Show details of the course -->
		</div>
				
		<!-- Hidden extra bits -->
		<div id="parts-confirm"  class="jqmWindow" style="display: none">
			<div id="parts-confirm-details">
			</div>
			<div>
			<form id="signup-confirm" action="#">
				<table>
					<tr>
						<th>
							<label for="supervisor-email">Supervisor Email</label>
						</th>
						<td><input type="text" class="valid-email" name="supervisor-email" id="supervisor-email" size="40"/></td>
					</tr>
					<tr>
						<th>
							<label for="supervisor-note">Message to supervisor</label>
						</th>
						<td><textarea name="supervisor-note" id="supervisor-note" cols="40" rows="8"></textarea></td>
					</tr>
				</table>
				<input type="submit" value="Confirm Signup"/>
				<input type="submit" class="cancel" value="Cancel"/>
			</form>
			</div>
		</div>
		
		<!-- ** Template for displaying a course ** -->
		<textarea id="details-tpl" style="display:none" rows="0" cols="0">
            <!-- Show details of the course -->
            <div id="summary" class="">
                <h3>${title}</h3>
                <table width="100%">
                	<tr>
                        <th>
                            Lecturers
                        </th>
                        <td>
                            {for teacher in teachers}
								<a href="mailto:${teacher.email}">${teacher.name}</a>
							{/for}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Course Administrators
                        </th>
                        <td>
                            {for admin in administrators}
								<a href="mailto:${admin.email}">${admin.name}</a>
							{/for}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Department
                        </th>
                        <td>
                            ${departmentCode}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Signup Available
                        </th>
                        <td>
                            13th September 2010 to 29th September 2010 (opens in 34 days)
                        </td>
                    </tr>
                </table>
            </div>
            <div id="description">
            	<h4>Description</h4>
				${description}
            </div>
			<div id="parts">
                <h4>Course Parts</h4>
				<span class="error" style="display:none"></span>
                <form id="signup" action="#">
                    <table width="100%">
                    	{for part in parts}
						<tr>
                            <th colspan="3">
                                ${part.type.name}
                            </th>
                        </tr>
						{for option in part.options}
                        <tr>
                            <td class="option-details">
                                <label for="seminar-1">${option.when} for ${option.sessions} sessions in ${option.term},
								{if option.presenter}<a href="mailto:${option.presenter.email}">${option.presenter.name}</a>{/if}
								</label>
                                <br/>
                                <span class="location">in Doctoral Training Centre, Rex Richards Building</span>
                            </td>
                            <td>
                                ${option.places} places
                            </td>
                            <td>
                                <input type="radio" name="${part.type.id}" id="option-${option.id}" value="option-${option.id}"
								 {if part.options.length == 1}checked="true"{/if}
								 {if full}disabled="true"{/if}/>
                            </td>
                        </tr>
						{/for}
						{/for}
                    </table><input type="submit" value="Signup" {if full}disabled="true"{/if}/>
                </form>
            </div>
		</textarea>
		
    </body>
</html>