<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Course Signup</title>
		
		<link rel="stylesheet" type="text/css" href="lib/jqmodal-r14/jqModal.css"/>
		<link rel="stylesheet" type="text/css" href="tool_base.css"/>
		<link rel="stylesheet" type="text/css" href="tool.css"/>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js">
		</script>
		<script type="text/javascript" src="lib/jstree-1.0rc/_lib/jquery.cookie.js">
		</script>
		<script type="text/javascript" src="lib/jstree-1.0rc/jquery.jstree.js">
		</script>
		<script type="text/javascript" src="lib/jqmodal-r14/jqModal.js">
		</script>
		<script type="text/javascript" src="lib/trimpath-template-1.0.38/trimpath-template.js">
		</script>
		<script type="text/javascript" src="lib/dataTables-1.6/js/jquery.dataTables.js">
		</script>
		<script type="text/javascript" src="lib/Text.js">
		</script>
		<script type="text/javascript" language="JavaScript">
		// Small jQuery plugin to get dates from server.
        (function($){
			
			var serverDate;
			var init = function() {
				if (!serverDate) {
					$.ajax({
						"url": "/course-signup/rest/user/current",
						"type": "GET",
						"async": false,
						"dataType": "json",
						"success": function(data) {
							serverDate = data.date;
						}
					});
				}
			};
			
            $.serverDate = function(){
                init();
                return serverDate;
                
            };
        })(jQuery);
			
			jQuery(function() {
				
				/**
				 * Compare two users to see if they are equal.
				 * @param {Object} user1
				 * @param {Object} user2
				 */
				var compareUser = function(user1, user2) {
					return (user1.id == user2.id && user1.name == user2.name && user1.email == user2.email);
				};
				
				/**
				 * Check is an object exists as a value in an array.
				 * @param {Object} array The array to look in.
				 * @param {Object} object To object to look for.
				 * @param {Object} compare A function to compare objects which returns true when they are the same.
				 */
				var inArray = function(array, object, compare) {
					for (var i in array) {
						if (compare(object, array[i])) {
							return true;
						}
					}
					return false;
				};

				/**
				 * Returns a summary about signup for this group.
				 * @param The components to produce a summary for.
				 */
				var signupSummary = function(components) {
					var now = $.serverDate();
					var nextOpen = Number.MAX_VALUE;
					var willClose = 0;
					var isOneOpen = false;
					var areSomePlaces = false;
					for(var i in components) {
						var component = components[i];
						var isOpen = component.opens < now && component.closes > now;
						if (component.opens > now && component.opens < nextOpen) {
							nextOpen = component.opens;
						}
						if (component.opens < now && component.closes > willClose) {
							willClose = component.closes;
						}
						if (isOpen) {
							isOneOpen = true;
							if (component.places > 0) {
								areSomePlaces = true;
							}
						}
					}
					var message = "";
					if (isOneOpen) {
						if (areSomePlaces) {
							var remaining = willClose - now;
							message = "close in "+ formatDuration(remaining);
						} else {
							message = "full";
						}
					} else {
						var until = nextOpen - now;
						message = "open in "+ formatDuration(until);
					}
					return message;
				};
                
                /**
                 * Formats a durations to display to the user.
                 * @param {Object} duration Duration in milliseconds.
                 */
                var formatDuration = function(remaining){
                    if (remaining < 1000) {
                        return "< 1 second";
                    } else 
                        if (remaining < 60000) {
                            return Math.floor(remaining / 1000) + " seconds";
                        } else 
                            if (remaining < 3600000) {
                                return Math.floor(remaining / 60000) + " minutes";
                            } else 
                                if (remaining < 86400000) {
                                    return Math.floor(remaining / 3600000) + " hours";
                                } else {
                                    return Math.floor(remaining / 86400000) + " days";
                                }
                };
				

				
				// Load the static data.
				jQuery.getJSON("data/department-tree.json", function(treedata) {
					var courseData;
					var signupData;
					
					var loadCourse = function(id){
							// Reset the data in-case someone clicked two items before we're loaded.
							courseData = undefined;
							signupData = undefined;
							jQuery.getJSON("/course-signup/rest/course/" + id, {
								range: "UPCOMING"
							}, function(data){
								courseData = data;
								showCourse();
							});
							jQuery.getJSON("/course-signup/rest/signup/my/course/" + id, {}, function(data){
								signupData = data;
								showCourse();
							});
						};
					
					var showCourse = function(){
							// Check we have all our data.
							if (!courseData || !signupData) {
								return;
							}
							
							var data = courseData; // From refactoring...
							var now = $.serverDate();
							var id = data.id;
							data.full = true;
							data.open = false;
							data.presenters = [];
							data.administrators = [];
							data.description = Text.toHtml(data.description);
							var parts = [];
							for(var componentIdx in data.components) {
								var component = data.components[componentIdx];
								
								// Sort components into sets.
								if (component.presenter && !inArray(data.presenters, component.presenter, compareUser)) {
									data.presenters.push(component.presenter);
								}
								if(component.administrator && !inArray(data.administrators, component.administrator, compareUser)) {
									data.administrators.push(component.administrator);
								}
								// Check it we're signed up to this one
								$.each(signupData, function() {
									// For all the components check...
									var signup = this; // So we can get at it.
									$.each(this.components, function() {
										if (component.id == this.id) {
											component.signup = signup;
										}
									});
								});
								
								if (component.componentSet) {
									var found = false;
									for (var part in parts) {
										if (parts[part].type.id == component.componentSet) {
											parts[part].signup = (component.signup)?component.signup:null;
											parts[part].options.push(component);
											found = true;
										}
									}
									if (!found) {
										parts.push({
											"options": [ component ],
											"signup": (component.signup)?component.signup:null,
											"type": {
												"id": component.componentSet,
												"name": component.title
											}
										});
									}
								}
								
								// Work out if it's open.
								component.open = (now > component.opens && now < component.closes);
								if (!data.open && component.open) {
									data.open = true;
								}
								// Is there space.
								component.full = (component.places < 1);
								if (data.full && !component.full) {
									data.full = false; // At least one is open 
								}
							}
							
							data.signup = signupSummary(data.components);
							
							data.parts = parts;
							console.log(data);
							var output = TrimPath.processDOMTemplate("details-tpl", data);
							//console.log(output.toString());
                            jQuery("#details").html(output);
                            jQuery("#signup").submit(function(){
								try {
									var radioSelected = {};
									var errorFound = false;
									var selectedParts = [];
									var selectedPartIds = [];
									jQuery("#signup input:radio").each(function(){
										var name = this.name;
										if (!radioSelected[name]) {
											radioSelected[name] = this.checked;
											// Save the selected parts so we can populate the popup.
											if (this.checked && this.value != "none") {
												selectedParts[selectedParts.length] = jQuery(this).parents("tr:first").find(".option-details").html();
												selectedPartIds.push(this.value);
											}
										}
										console.log(name + " " + radioSelected[name]);
									});
									for (radio in radioSelected) {
										if (!radioSelected[radio]) {
											errorFound = true;
											jQuery("#parts .error").show().html("Error");
										}
									}
									if (!errorFound) {
										jQuery("#parts .error").hide();
										var listNode = jQuery("#parts-confirm-details").empty().append(jQuery("#summary h3").clone()).append("<ul><li>" + selectedParts.join("</li><li>") + "</li></ul>");
										
										// Actually show the dialogue (resized first)
										var dialog = jQuery("#parts-confirm");
										dialog.height(dialog.innerHeight());
										dialog.data("components", selectedPartIds);
										var templateData = {
											"components": selectedParts,
											"componentIds": selectedPartIds,
											"course": data.title,
											"courseId": id
										};
										var confirmText = TrimPath.processDOMTemplate("parts-confirm-tpl", templateData);
										dialog.html(confirmText);
										confirmSetup(dialog);
										dialog.jqmShow();
									}
									return false;
								} catch (e) {
									console.log(e);
									return false;
								}
                            });
						};
				
				/**
				 * This handles the dialogue box for confirming a signup.
				 * @param {Object} dialog
				 */
				var confirmSetup = function(dialog){
                    var signupConfirm = jQuery("#signup-confirm");
                    
                    signupConfirm.find(".cancel").click(function(event){
                        jQuery("#parts-confirm").jqmHide();
                        event.stopPropagation();
                        return false;
                    });
					
                    signupConfirm.submit(function(event){
                        // Need todo validation 
                        var form = jQuery(this);
                        var error = false;
                        form.find(".error").remove();
                        form.find(".msg").remove()
                        form.find(".valid-email").each(function(){
                            console.log(this);
                            var current = jQuery(this);
                            if (current.val().length == 0) {
                                current.after('<span class="error">* required</span>');
                                error = true;
                            }
                            else {
                                if (!/^([a-zA-Z0-9_.-])+@([a-zA-Z0-9_.-])+\.([a-zA-Z])+([a-zA-Z])+/.test(current.val())) {
                                    current.after('<span class="error">not a valid email</span>');
                                    error = true;
                                }
                            }
                        });
                        
                        if (error) {
                            return false;
                        }
                        
                        //form.find("input:submit:first").attr("disabled", "true").before('<img class="loader" src="images/loader.gif"/>');
                        var components = jQuery("#parts-confirm").data("components");
                        var courseId = jQuery("input[name=courseId]", this).first().val();
                        var email = jQuery("input[name=supervisor-email]").first().val();
                        var note = jQuery("input[name=supervisor-note]").first().val();
                        jQuery.post("/course-signup/rest/signup/new", form.serialize(), function(){
                            form.find("input:submit").removeAttr("disabled");
                            form.find(".loader").remove();
                            dialog.jqmHide();
							loadCourse(courseId); // Not in scope.
                        });
                        return false;
                    });
                };
				
				var loadNodeDetails = function(id) {
					$.get("/course-signup/static/data/html/"+id+".html", function(data) {
						$("#details").html(data);
					});
				};
					
					jQuery("#tree")
					.bind("select_node.jstree", function(event, data) {
						// Starts the loading of course details.
						var currentNode = data.rslt.obj[0];
						var id = currentNode.id;
						if ($(currentNode).is(".jstree-leaf")) {
							loadCourse(id);
						} else {
							loadNodeDetails(id);
						}
					})
					.delegate(".jstree-closed a", "click", function(e) {
						$("#tree").jstree("open_node", this);
					})
				 	.jstree({
						json_data: {
							data: treedata,
							ajax: {
								url: function (n) {
									var id = n.attr("id");
									id = id.replace(/-PREVIOUS$/, "");
									return "/course-signup/rest/course/dept/"+ id;
								},
								data: function(n) {
									if (n.attr("id").match(/-PREVIOUS$/)) {
										return {components: "PREVIOUS"};
									}
									return {components: "UPCOMING"};
								},
								dataType: "json",
								success: function (data) {
									if ("UPCOMING" == data.range) {
										data.tree.push({
											"attr":{"id": data.dept+"-PREVIOUS"},
											"data":"Old",
											"state": "closed"
										})
									}
									return data.tree;
								}
							}
							//correct_state: true
						},
						core: {
							initially_open: ["root", "3C", "3C05"] // Open up MPLS for testing.
						},
						plugins: ["themes", "json_data", "ui"]
					});	
				});
			});
			jQuery(
				function() {
					jQuery("#parts-confirm").jqm({modal:false});
			
				}
			);
			
		</script>
		
        <style type="text/css">
            .location {
                font-size: smaller;
            }
			.error {
				color: red;
			}
            
            table th {
                text-align: left;
            }
            
            #summary {
                background: #bbb;
            }
			
			#parts table th {
				padding: 0.5em;
			}
			
			#parts table td {
				vertical-align: top;
				/* Indent all but first line */
				padding-left: 3em;
				text-indent: -3em;
			}
			
			#browse {
				width: 30%;
				float: left;
				overflow: hidden;
			}
			#details {
				width: 69%;
				float: right;
			}
			.loader {
				float: left;
			}
			
			.jqmWindow {
				z-index: 1000; /* To keep below autocomplete */
				background: white;
				overflow: auto;
				height: 300px;
			}
        </style>
    </head>
    <body>
    	<div id="toolbar" >
        	<ul class="navIntraTool actionToolBar">
            <li><span>Course Signup</span></li>
            <li><span><a href="my.html">My Courses</a></span></li>
            <li><span><a href="#">Pending Acceptances</a></span></li>
            <li><span><a href="admin.html">Course Administration</a></span></li>
            <li><span><a href="debug.html">Debug</a></span></li>
			</ul>
        </div>
		
        <div id="browse">
            <!-- Browse the areas which there are courses -->
			<div id="tree"></div>
        </div>
        <div id="details">
            <!-- Show details of the course -->
		</div>
				
		<!-- Hidden extra bits -->
		<div id="parts-confirm"  class="jqmWindow" style="display: none">
			
		</div>
		
		<textarea id="parts-confirm-tpl" style="display: none;" rows="0" cols="0">
			<h2>Signup to: ${course}</h2>
			{var textarea = "textarea"}
			<div>
				<ul>
				{for component in components}
					<li>${component}</li>
				{/for}
				</ul>
			</div>
			<div>
			<form id="signup-confirm" action="#">
				{for componentId in componentIds}
				<input type="hidden" name="components" value="${componentId}"/>
				{/for}
				<input type="hidden" name="courseId" value="${courseId}"/>
				<table>
					<tr>
						<th>
							<label for="supervisor-email">Supervisor Email</label>
						</th>
						<td><input type="text" class="valid-email" name="email" id="supervisor-email" size="40"/></td>
					</tr>
					<tr>
						<th>
							<label for="supervisor-note">Message to supervisor</label>
						</th>
						<td><${textarea} name="message" id="supervisor-note" cols="40" rows="8"></${textarea}></td>
					</tr>
				</table>
				<input type="submit" value="Confirm Signup"/>
				<input type="submit" class="cancel" value="Cancel"/>
			</form>
			</div>
		</textarea>
		
		<!-- ** Template for displaying a course ** -->
		<textarea id="details-tpl" style="display:none" rows="0" cols="0">
            <!-- Show details of the course -->
            <div id="summary" class="">
                <h3>${title}</h3>
                <table width="100%">
                	<tr>
                        <th>
                            Lecturers
                        </th>
                        <td>
                            {for presenter in presenters}
								<a href="mailto:${presenter.email}">${presenter.name}</a>
							{/for}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Course Administrators
                        </th>
                        <td>
                            {for admin in administrators}
								<a href="mailto:${admin.email}">${admin.name}</a>
							{/for}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Department
                        </th>
                        <td>
                        	{if defined('department')}
                            	${department}
							{else}
								${departmentCode}
							{/if}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Signup Available
                        </th>
                        <td>
                            ${signup}
                        </td>
                    </tr>
                </table>
            </div>
            <div id="description">
            	<h4>Description</h4>
				${description}
            </div>
			<div id="parts">
                <h4>Course Parts</h4>
				<span class="error" style="display:none"></span>
                <form id="signup" action="#">
                    <table width="100%">
                    	{for part in parts}
						<tr>
                            <th colspan="3">
                                ${part.type.name}
                            </th>
                        </tr>
						{var oneOpen = false}
						{var signup = part.signup}
						{for option in part.options}
                        <tr>
                            <td class="option-details">
                                <label for="option-${option.id}">${option.slot} for ${option.sessions} sessions in ${option.when},
								{if option.presenter}<a href="mailto:${option.presenter.email}">${option.presenter.name}</a>{/if}
								</label>
                                <br/>
                                <span class="location">${option.location}</span>
                            </td>
                            <td>
                            	{if option.full}
									full
								{else}
									${option.places} places
								{/if}
                            </td>
                            <td>
                            	
								{if option.signup}
									Signup: ${option.signup.status}
								{else}
                                <input type="radio" name="${part.type.id}" id="option-${option.id}" value="${option.id}"
								 {if option.full || !option.open }disabled="true"{else}{var oneOpen = true}{/if}/>
								{/if}
                            </td>
                        </tr>
						{/for}
						{if parts.length > 1 && oneOpen}
						<tr>
							<td class="option-details">
								<label for="option-none-${part.type.id}">Nothing for this option</label>
							</td>
							<td>N/A</td>
							<td><input type="radio" name="${part.type.id}" id="option-none-${part.type.id}" value="none"/></td>
						</tr>
						{/if}
						{/for}
                    </table><input type="submit" value="Signup" {if full || !open}disabled="true"{/if}/>
                </form>
            </div>
		</textarea>
		
    </body>
</html>